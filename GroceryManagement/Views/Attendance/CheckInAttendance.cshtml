@{
    ViewBag.Title = "Check In Attendance";
    var info = TempData["Info"] as string;
    var currentDate = ViewBag.CurrentDate as string ?? DateTime.Now.ToString("yyyy-MM-dd");
    var currentTime = ViewBag.CurrentTime as string ?? DateTime.Now.ToString("HH:mm");
    var hasCheckIn = ViewBag.HasCheckIn as bool? ?? false;
    var staffId = ViewBag.StaffId as string ?? "";
}

<h2>Check In Attendance</h2>

<p><strong>Staff ID:</strong> @staffId</p>

@if (!string.IsNullOrWhiteSpace(info))
{
    <div class="alert">@Html.Raw(info)</div>
}

@if (ViewBag.CheckInInfo != null)
{
    <div class="alert">@ViewBag.CheckInInfo</div>
}

@if (ViewBag.CheckOutInfo != null)
{
    <div class="alert">@ViewBag.CheckOutInfo</div>
}

<form asp-action="CheckIn" method="post">
    @Html.AntiForgeryToken()
    
    <div>
        <label for="overrideDate">Date (for testing override)</label>
        <input id="overrideDate" type="date" name="overrideDate" value="@currentDate" />
    </div>

    <div>
        <label for="overrideTime">Time (for testing override)</label>
        <input id="overrideTime" type="time" name="overrideTime" value="@currentTime" />
        <small>Leave empty to use current date/time.</small>
    </div>

    <button type="submit">Check in now</button>
</form>

<hr />

<form id="checkoutForm" asp-action="CheckOut" method="post">
    @Html.AntiForgeryToken()
    <input type="hidden" id="checkoutDate" name="overrideDate" value="@currentDate" />
    <input type="hidden" id="checkoutTime" name="overrideTime" value="@currentTime" />

    <button type="submit" @(hasCheckIn ? "" : "disabled")>Check out</button>
    @if (!hasCheckIn)
    {
        <small>Checkout disabled until you check in for the selected date.</small>
    }
</form>

<script>
    (() => {
        const date = document.getElementById("overrideDate");
        const time = document.getElementById("overrideTime");
        const checkoutDate = document.getElementById("checkoutDate");
        const checkoutTime = document.getElementById("checkoutTime");

        const sync = () => {
            if (checkoutDate) checkoutDate.value = date.value;
            if (checkoutTime) checkoutTime.value = time.value;
        };

        [date, time].forEach(el => el?.addEventListener('change', sync));
        sync();

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Function to show notification with sound
        function showNotification(title, body, soundType) {
            // Show desktop notification
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: '/images/favicon.png',
                    badge: '/images/favicon.png',
                    requireInteraction: true
                });

                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
            }

            // Play sound
            playSound(soundType);
        }

        // Function to play sound
        function playSound(type) {
            const audio = new Audio();
            if (type === 'checkin') {
                // Bell sound frequency for check-in
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } else if (type === 'checkout') {
                // Lower bell sound for check-out
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 600;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        // Check if there's a check-in or check-out notification flag
        const showCheckIn = '@TempData["ShowCheckInNotification"]';
        const showCheckOut = '@TempData["ShowCheckOutNotification"]';

        if (showCheckIn === 'true') {
            showNotification('Check-In Successful', 'You have successfully checked in!', 'checkin');
        }

        if (showCheckOut === 'true') {
            showNotification('Check-Out Successful', 'You have successfully checked out!', 'checkout');
        }
    })();
</script>