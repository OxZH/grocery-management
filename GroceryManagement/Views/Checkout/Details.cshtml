@model Checkout
@{
    ViewBag.Title = "Checkout Details - " + Model.Id;
    var timeline = (List<(string status, DateTime at)>)ViewBag.Timeline ?? new List<(string, DateTime)>();
    var workflow = (string[])ViewBag.Workflow ?? new string[] { "PENDING","PICKING","PACKED","READY","COMPLETED","CANCELLED" };
}

<h2>Checkout @Model.Id</h2>
<p>Date: @Model.Date</p>
<p>Total: @Model.Total</p>
<p>Status: <strong id="currentStatus">@Model.Status</strong></p>

<div>
    <h4>Items</h4>
    @{
        var invs = Model.Inventories ?? new List<GroceryManagement.Models.Inventory>();
        var grouped = invs.GroupBy(i => i.ProductId).ToList();
    }
    @if (!grouped.Any())
    {
        <p>No items linked to this checkout.</p>
    }
    else
    {
        <table class="table">
            <tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Line Total</th></tr>
            @foreach (var g in grouped)
            {
                var prod = g.First().Product;
                var price = prod?.Price ?? 0m;
                var qty = g.Count();
                <tr>
                    <td>@(prod?.Name ?? g.Key)</td>
                    <td>@qty</td>
                    <td>@price</td>
                    <td>@(price * qty)</td>
                </tr>
            }
        </table>
    }
</div>

<div>
    <h4>Timeline</h4>
    <ul id="timeline">
        @foreach(var t in timeline)
        {
            <li>@t.status - @t.at</li>
        }
    </ul>
</div>

<div>
    <h4>Change Status</h4>
    <select id="statusSelect">
        @{ var currentIdx = Array.IndexOf(workflow, Model.Status ?? "PENDING"); }
        @for (int i = 0; i < workflow.Length; i++)
        {
            var s = workflow[i];
            <option value="@s" disabled="@(i < currentIdx && s != "CANCELLED" ? "disabled" : null)" selected="@(s == Model.Status ? "selected" : null)">@s</option>
        }
    </select>
    <button id="btnUpdate">Update</button>
</div>

<div>
    <h4>Packing Slip</h4>
    <a href="/Checkout/PackingSlip/@Model.Id" target="_blank">Open Packing Slip</a>
</div>

<script>
    document.getElementById('btnUpdate').addEventListener('click', async function(){
        var newStatus = document.getElementById('statusSelect').value;
        var id = '@Model.Id';
        var resp = await fetch('/Checkout/UpdateStatus', { method: 'POST', headers: { 'Content-Type':'application/x-www-form-urlencoded' }, body: 'id='+encodeURIComponent(id)+'&newStatus='+encodeURIComponent(newStatus)});
        if (resp.ok){
            var data = await resp.json();
            document.getElementById('currentStatus').textContent = data.status;
            var ul = document.getElementById('timeline');
            var li = document.createElement('li');
            li.textContent = data.status + ' - ' + new Date().toLocaleString();
            ul.appendChild(li);
            alert('Status updated');
        } else {
            var txt = await resp.text();
            alert('Failed: '+txt);
        }
    });
</script>
