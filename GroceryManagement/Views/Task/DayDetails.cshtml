@model DayDetailsVM
@{
    ViewData["Title"] = "Day Schedule Details";
}

<h1>Schedule for @Model.Date.ToString("dddd, MMMM dd, yyyy")</h1>
<h3>Template: @Model.TemplateName</h3>

@Html.Raw(TempData["Info"])

@if (Model.HasUnavailableStaff && !Model.IsAcknowledged)
{
    <div class="alert alert-warning">
        <strong>⚠ Warning:</strong> Some staff members are unavailable (absent or on leave).
        You can reassign their tasks to available staff, or acknowledge and keep assignments as-is.
    </div>
}

@if (Model.IsAcknowledged)
{
    <div class="alert alert-info">
        <strong>ℹ️ Acknowledged:</strong> This schedule has staff unavailability that has been acknowledged.
    </div>
}

<div>
    @if (Model.HasUnavailableStaff && !Model.IsAcknowledged)
    {
        <form method="post" asp-action="AcknowledgeDay" class="inline-form">
            @Html.AntiForgeryToken()
            <input type="hidden" name="dateStr" value="@Model.Date.ToString("yyyy-MM-dd")" />
            <button type="submit" onclick="return confirm('Acknowledge unavailable staff and keep current assignments?');">Acknowledge All</button>
        </form>
    }
    <form method="post" asp-action="DeleteSchedule" class="inline-form">
        @Html.AntiForgeryToken()
        <input type="hidden" name="dateStr" value="@Model.Date.ToString("yyyy-MM-dd")" />
        <button type="submit" onclick="return confirm('Delete this entire schedule?');">Delete Schedule</button>
    </form>
    <a href="@Url.Action("DayManagement", new { dateStr = Model.Date.ToString("yyyy-MM-dd") })">Back to Day Management</a>
</div>

<h3>Task Assignments</h3>

<div>
    <button type="button" onclick="showAddStaffModal()">+ Add Staff to Schedule</button>
</div>

<table class="table">
    <thead>
        <tr>
            <th>Staff</th>
            <th>Task</th>
            <th>Attendance</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var alloc in Model.Allocations)
        {
            var rowClass = alloc.IsUnavailable ? "unavailable-row" : "";
            <tr class="@rowClass">
                <td>
                    <strong>@alloc.StaffName</strong><br/>
                    <small>(@alloc.StaffId)</small>
                </td>
                <td>
                    <strong>@alloc.TaskName</strong>
                    @if (alloc.StartTime != null)
                    {
                        <br/><small>Started: @alloc.StartTime.Value.ToString("HH:mm")</small>
                    }
                    @if (alloc.CompletionDate != null)
                    {
                        <br/><small>Completed: @alloc.CompletionDate.Value.ToString("HH:mm")</small>
                    }
                </td>
                <td>
                    <span class="badge badge-@(alloc.AttendanceStatus == "ATTEND" ? "success" : "danger")">
                        @alloc.AttendanceStatus
                    </span>
                </td>
                <td>
                    <span class="badge badge-@(alloc.Status == "COMPLETED" ? "success" : alloc.Status == "IN_PROGRESS" ? "info" : "secondary")">
                        @alloc.Status
                    </span>
                </td>
                <td>
                    <button type="button" onclick="showEditTaskForm('@alloc.AllocationId', '@alloc.StaffName', '@alloc.TaskName')">
                        Edit Task
                    </button>
                    <form method="post" asp-action="DeleteStaffAllocation" class="inline-form">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="allocationId" value="@alloc.AllocationId" />
                        <input type="hidden" name="dateStr" value="@Model.Date.ToString("yyyy-MM-dd")" />
                        <button type="submit" onclick="return confirm('Delete @alloc.StaffName from schedule?');">
                            Delete
                        </button>
                    </form>
                </td>
            </tr>
            @if (!string.IsNullOrWhiteSpace(alloc.Notes))
            {
                <tr class="@rowClass">
                    <td colspan="5" class="notes-row">
                        <small><strong>Notes:</strong> @alloc.Notes</small>
                    </td>
                </tr>
            }
        }
    </tbody>
</table>

<!-- Edit Task Modal -->
<div id="editTaskModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeEditTaskModal()">&times;</span>
        <h3>Edit Task</h3>
        <form method="post" asp-action="EditTaskName">
            @Html.AntiForgeryToken()
            <input type="hidden" name="dateStr" value="@Model.Date.ToString("yyyy-MM-dd")" />
            <input type="hidden" id="editAllocationId" name="allocationId" />
            
            <p id="editTaskInfo"></p>
            
            <div class="form-group">
                <label>Select Task Type:</label>
                <select id="editTaskName" name="newTaskName" class="form-control" required>
                    <option value="">-- Select Task Type --</option>
                    @foreach (var taskType in ViewBag.TaskTypes as SelectList)
                    {
                        <option value="@taskType.Text">@taskType.Text</option>
                    }
                </select>
            </div>
            
            <div>
                <button type="submit">Update Task</button>
                <button type="button" onclick="closeEditTaskModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Staff Modal -->
<div id="addStaffModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="closeAddStaffModal()">&times;</span>
        <h3>Add Staff to Schedule</h3>
        <form method="post" asp-action="AddStaffToDay">
            @Html.AntiForgeryToken()
            <input type="hidden" name="dateStr" value="@Model.Date.ToString("yyyy-MM-dd")" />
            
            <div class="form-group">
                <label>Select Staff:</label>
                <select name="staffId" class="form-control" required>
                    <option value="">-- Select Staff --</option>
                    @foreach (var staff in Model.AvailableStaffForReassignment)
                    {
                        <option value="@staff.Id">@staff.Name (@staff.Id) - @staff.AuthorizationLvl</option>
                    }
                </select>
            </div>
            
            <div class="form-group">
                <label>Select Task:</label>
                <select name="taskName" class="form-control" required>
                    <option value="">-- Select Task Type --</option>
                    @foreach (var taskType in ViewBag.TaskTypes as SelectList)
                    {
                        <option value="@taskType.Text">@taskType.Text</option>
                    }
                </select>
            </div>
            
            <div>
                <button type="submit">Add Staff</button>
                <button type="button" onclick="closeAddStaffModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
    function showEditTaskForm(allocationId, staffName, currentTaskName) {
        document.getElementById('editAllocationId').value = allocationId;
        document.getElementById('editTaskInfo').textContent = `Editing task for ${staffName}`;
        document.getElementById('editTaskName').value = currentTaskName;
        document.getElementById('editTaskModal').style.display = 'block';
    }
    
    function closeEditTaskModal() {
        document.getElementById('editTaskModal').style.display = 'none';
    }
    
    function showAddStaffModal() {
        document.getElementById('addStaffModal').style.display = 'block';
    }
    
    function closeAddStaffModal() {
        document.getElementById('addStaffModal').style.display = 'none';
    }
    
    window.onclick = function(event) {
        const editModal = document.getElementById('editTaskModal');
        const addStaffModal = document.getElementById('addStaffModal');
        if (event.target == editModal) {
            closeEditTaskModal();
        }
        if (event.target == addStaffModal) {
            closeAddStaffModal();
        }
    }
</script>

<style>
    .inline-form {
        display: inline;
    }
    .unavailable-row td {
        background-color: #fff3cd;
    }
    .notes-row {
        background-color: #f8f9fa;
        padding-left: 30px;
    }
    .badge-success { background-color: #28a745; color: white; }
    .badge-danger { background-color: #dc3545; color: white; }
    .badge-info { background-color: #17a2b8; color: white; }
    .badge-secondary { background-color: #999; color: white; }
    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid #333;
    }
    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
    }
    .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #333;
        width: 80%;
        max-width: 500px;
    }
    .close {
        color: #999;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    .close:hover {
        color: #333;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-control, select {
        width: 100%;
        padding: 5px;
        border: 1px solid #333;
    }
</style>

